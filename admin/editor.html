<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFW Vedanta - Page Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/monokai.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1e1e1e; color: white; }
        .header { background: #FF9933; padding: 0.75rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem; }
        .header-actions { display: flex; gap: 0.75rem; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 500; }
        .btn-preview { background: white; color: #FF9933; }
        .btn-save { background: #28a745; color: white; }
        .btn:hover { opacity: 0.9; }
        .container { display: flex; height: calc(100vh - 52px); }
        .sidebar { width: 200px; background: #252526; border-right: 1px solid #3c3c3c; overflow-y: auto; }
        .sidebar-header { padding: 0.75rem 1rem; background: #333; font-size: 0.75rem; text-transform: uppercase; color: #888; }
        .page-list { list-style: none; }
        .page-list li { padding: 0.625rem 1rem; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #333; }
        .page-list li:hover { background: #2a2d2e; }
        .page-list li.active { background: #094771; }
        .main-area { flex: 1; display: flex; flex-direction: column; }
        .editor-preview { flex: 1; display: flex; }
        .code-panel { flex: 1; display: flex; flex-direction: column; border-right: 1px solid #3c3c3c; }
        .preview-panel { flex: 1; display: flex; flex-direction: column; background: #fff; }
        .panel-header { padding: 0.5rem 1rem; background: #333; font-size: 0.8rem; color: #888; display: flex; justify-content: space-between; }
        .preview-panel .panel-header { background: #f5f5f5; color: #666; }
        .CodeMirror { flex: 1; height: auto !important; font-size: 14px; }
        #preview-frame { flex: 1; border: none; }
        .status-bar { padding: 0.5rem 1rem; background: #007acc; font-size: 0.8rem; }
        .loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .loading.hidden { display: none; }
        .spinner { width: 30px; height: 30px; border: 3px solid #333; border-top: 3px solid #FF9933; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .search-box { padding: 0.5rem; background: #333; }
        .search-box input { width: 100%; padding: 0.5rem; border: 1px solid #555; background: #3c3c3c; color: white; border-radius: 4px; font-size: 0.85rem; }
        .search-box input::placeholder { color: #888; }
    </style>
</head>
<body>
    <div class="loading" id="loading"><div class="spinner"></div></div>

    <div class="header">
        <h1>üïâÔ∏è DFW Vedanta Editor</h1>
        <div class="header-actions">
            <button class="btn btn-preview" onclick="refreshPreview()">üîÑ Refresh Preview</button>
            <button class="btn btn-save" onclick="savePage()">üíæ Save & Publish</button>
        </div>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">Pages</div>
            <div class="search-box">
                <input type="text" placeholder="Search pages..." id="searchInput" onkeyup="filterPages()">
            </div>
            <ul class="page-list" id="pageList">
                <li data-page="index.html">üè† Home</li>
                <li data-page="aboutus.html">‚ÑπÔ∏è About Us</li>
                <li data-page="calendar.html">üìÖ Calendar</li>
                <li data-page="programs.html">üìã Programs</li>
                <li data-page="ramakrishna.html">üôè Sri Ramakrishna</li>
                <li data-page="sarada-devi.html">üôè Sri Sarada Devi</li>
                <li data-page="vivekananda.html">üôè Swami Vivekananda</li>
                <li data-page="vedanta.html">üìñ Vedanta</li>
                <li data-page="meditation.html">üßò Meditation</li>
                <li data-page="leadership.html">üë• Leadership</li>
                <li data-page="newsletter.html">üì∞ Newsletter</li>
                <li data-page="social-services.html">ü§ù Social Services</li>
                <li data-page="contactus.html">üìû Contact Us</li>
                <li data-page="donate.html">üíù Donate</li>
                <li data-page="styles.css">üé® Styles (CSS)</li>
                <li data-page="script.js">‚öôÔ∏è Scripts (JS)</li>
            </ul>
        </div>
        
        <div class="main-area">
            <div class="editor-preview">
                <div class="code-panel">
                    <div class="panel-header">
                        <span>üìù Code Editor</span>
                        <span id="cursorPos">Ln 1, Col 1</span>
                    </div>
                    <textarea id="code-editor"></textarea>
                </div>
                <div class="preview-panel">
                    <div class="panel-header">
                        <span>üëÅÔ∏è Live Preview</span>
                        <span id="previewStatus">Ready</span>
                    </div>
                    <iframe id="preview-frame" sandbox="allow-same-origin allow-scripts"></iframe>
                </div>
            </div>
            <div class="status-bar" id="status">Select a page to edit</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
    <script>
        let currentPage = null;
        let fileSha = null;
        let editor = null;
        let githubToken = localStorage.getItem('github_token');
        const REPO = 'vinaysolapurkar/vedantadfw';
        const BRANCH = 'master';
        
        if (!githubToken) {
            githubToken = prompt('GitHub Personal Access Token (needs repo scope):\nCreate at github.com/settings/tokens');
            if (githubToken) localStorage.setItem('github_token', githubToken);
        }
        
        // Initialize CodeMirror
        editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            mode: 'htmlmixed',
            theme: 'monokai',
            lineNumbers: true,
            lineWrapping: true,
            indentUnit: 2,
            tabSize: 2,
            autoCloseTags: true,
            matchBrackets: true
        });
        
        editor.on('cursorActivity', () => {
            const pos = editor.getCursor();
            document.getElementById('cursorPos').textContent = `Ln ${pos.line + 1}, Col ${pos.ch + 1}`;
        });
        
        // Auto-refresh preview on change (debounced)
        let previewTimeout;
        editor.on('change', () => {
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(refreshPreview, 1000);
        });
        
        document.getElementById('loading').classList.add('hidden');
        
        // Page list
        document.querySelectorAll('.page-list li').forEach(li => {
            li.addEventListener('click', () => loadPage(li.dataset.page));
        });
        
        function filterPages() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.page-list li').forEach(li => {
                li.style.display = li.textContent.toLowerCase().includes(query) ? '' : 'none';
            });
        }
        
        async function loadPage(pageName) {
            currentPage = pageName;
            document.querySelectorAll('.page-list li').forEach(li => {
                li.classList.toggle('active', li.dataset.page === pageName);
            });
            
            setStatus('Loading ' + pageName + '...');
            document.getElementById('loading').classList.remove('hidden');
            
            // Set mode based on file type
            if (pageName.endsWith('.css')) {
                editor.setOption('mode', 'css');
            } else if (pageName.endsWith('.js')) {
                editor.setOption('mode', 'javascript');
            } else {
                editor.setOption('mode', 'htmlmixed');
            }
            
            try {
                const response = await fetch(`https://api.github.com/repos/${REPO}/contents/v2/${pageName}?ref=${BRANCH}`, {
                    headers: githubToken ? { 'Authorization': `token ${githubToken}` } : {}
                });
                
                if (!response.ok) throw new Error('HTTP ' + response.status);
                
                const data = await response.json();
                fileSha = data.sha;
                const content = decodeURIComponent(escape(atob(data.content)));
                
                editor.setValue(content);
                editor.refresh();
                refreshPreview();
                
                setStatus(`Loaded: ${pageName} (${content.length.toLocaleString()} bytes)`);
            } catch (error) {
                setStatus('Error: ' + error.message);
            }
            
            document.getElementById('loading').classList.add('hidden');
        }
        
        function refreshPreview() {
            if (!currentPage) return;
            
            const code = editor.getValue();
            const frame = document.getElementById('preview-frame');
            document.getElementById('previewStatus').textContent = 'Updating...';
            
            if (currentPage.endsWith('.html')) {
                // For HTML, inject the full page with absolute URLs
                let html = code.replace(/href="styles\.css"/g, 'href="https://v2-sigma-two.vercel.app/styles.css"');
                html = html.replace(/src="script\.js"/g, 'src="https://v2-sigma-two.vercel.app/script.js"');
                html = html.replace(/src="images\//g, 'src="https://v2-sigma-two.vercel.app/images/');
                html = html.replace(/href="([^"]+)\.html"/g, 'href="https://v2-sigma-two.vercel.app/$1.html"');
                frame.srcdoc = html;
            } else if (currentPage.endsWith('.css')) {
                // For CSS, show it applied to a sample page
                frame.srcdoc = `<!DOCTYPE html>
                    <html><head><style>${code}</style></head>
                    <body style="padding:2rem;font-family:sans-serif;">
                        <h1>CSS Preview</h1>
                        <p>Styles applied. Check the actual pages to see full effect.</p>
                        <button class="btn btn-primary">Sample Button</button>
                    </body></html>`;
            } else {
                frame.srcdoc = `<pre style="padding:1rem;white-space:pre-wrap;">${code.replace(/</g,'&lt;')}</pre>`;
            }
            
            setTimeout(() => {
                document.getElementById('previewStatus').textContent = 'Ready';
            }, 500);
        }
        
        async function savePage() {
            if (!currentPage || !fileSha) {
                alert('Load a page first');
                return;
            }
            
            setStatus('Saving...');
            document.getElementById('loading').classList.remove('hidden');
            
            try {
                const content = editor.getValue();
                
                const response = await fetch(`https://api.github.com/repos/${REPO}/contents/v2/${currentPage}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update ${currentPage}`,
                        content: btoa(unescape(encodeURIComponent(content))),
                        sha: fileSha,
                        branch: BRANCH
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    fileSha = data.content.sha;
                    setStatus('‚úÖ Saved! Vercel deploying (~30s)...');
                } else {
                    const error = await response.json();
                    throw new Error(error.message);
                }
            } catch (error) {
                setStatus('‚ùå ' + error.message);
            }
            
            document.getElementById('loading').classList.add('hidden');
        }
        
        function setStatus(msg) {
            document.getElementById('status').textContent = msg;
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                savePage();
            }
        });
    </script>
</body>
</html>
